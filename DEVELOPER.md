## Insertion Order SPA — Developer Guide

This document explains how the app is structured, how to run it locally, how submission works with Netlify Forms, and how to extend it safely.

### Tech stack
- **Framework**: React 18 + TypeScript, Vite
- **Styling**: Tailwind CSS v4 utilities (via `@import "tailwindcss"`)
- **Forms**: React Hook Form + Zod (`IoSchema`)
- **Hosting**: Netlify (static site) + Netlify Forms capture

### High-level features
- Step-by-step IO form with validation and gating
- Single-initiator model: Seller info comes from org config; Buyer fills their details
- Autosave to `localStorage` with hydration on reload
- File uploads (W‑9, attachments) with multipart detect
- Canvas signatures for Buyer and Seller
- Review step, JSON export, print-friendly UI

---

## Getting started

### Prerequisites
- Node 18+ (or 20+ recommended), pnpm installed

### Install and run

```bash
pnpm install
pnpm dev
```

Build and preview:

```bash
pnpm build
pnpm preview
```

Lint:

```bash
pnpm lint
```

> We use Vite HMR in dev. The app is an SPA with a single entry (`index.html`).

---

## Project structure

```
src/
  app/                    # (optional scaffolding)
  assets/
  components/             # Reusable UI components
    FileInput.tsx         # File chooser bound to RHF
    JsonExportButton.tsx  # Download current form as JSON
    PrintButton.tsx       # window.print() with print:hidden
    SignaturePad.tsx      # Canvas signature → dataURL field
    Stepper.tsx
    FormSection.tsx
  features/
    io/
      IoForm.tsx          # Stepper container, gating, submit
      schema.ts           # Zod schema and types
      steps/              # Per-step UIs
        PartiesStep.tsx
        CampaignStep.tsx
        PricingStep.tsx
        ComplianceStep.tsx
        BillingStep.tsx
        TermsStep.tsx
        SignaturesStep.tsx
  hooks/
    useAutosave.ts        # Hydrate + debounce-save to localStorage
  lib/
    netlify.ts            # encode x-www-form-urlencoded, multipart, post
    printing.ts           # print helpers
    analytics.ts          # (placeholder)
    org.ts                # Seller org defaults and merge helper
App.tsx
index.css
main.tsx
```

---

## Configuration

### Seller org defaults
Update `src/lib/org.ts` with your Seller/Publisher info. These values are locked in the UI and merged automatically at submit time. If left empty, the Parties step renders a warning.

```ts
export const ORG_SELLER_DEFAULTS = {
  seller_company: 'Acme Performance LLC',
  seller_contact: 'Alex Example',
  seller_email: 'alex@example.com',
  seller_phone: '+1 555 0100',
  seller_address: '123 Example St, City, ST',
};
```

### Netlify Forms
- The form is posted to `/` and captured by Netlify Forms via hidden inputs.
- Hidden form config lives in `index.html` (generated by Vite) and the React `<form>` includes:
  - `name="io-form"`, `data-netlify="true"`, `data-netlify-honeypot="bot-field"`, hidden `form-name` and `bot-field` inputs.
- Submission helper lives in `src/lib/netlify.ts`:
  - `encodeFormUrl` for x-www-form-urlencoded
  - `buildMultipartFormData` for files
  - `postToNetlify(payload, { multipart })` auto-includes `form-name` + honeypot

Optional reCAPTCHA:
- Add `<div data-netlify-recaptcha="true"></div>` inside the form and pass `recaptchaToken` to `postToNetlify`. Ensure Netlify reCAPTCHA is enabled for the site.

### Tailwind and theme
- Neutral gradient background is defined in `App.tsx` using utility classes.
- Use `print:` variants (e.g., `print:hidden`) to hide controls for printing.

---

## Form behavior

### Schema and validation
Defined in `src/features/io/schema.ts` with Zod; RHF uses `zodResolver`. Required fields per step:
- Parties: `buyer_company`, `buyer_contact`, `buyer_email`
- Campaign: `offer_name`, `vertical`, `start_date`
- Pricing: `payout_model`, `price_per_call`, `qual_seconds`
- Billing: `billing_cycle`
- Other fields are optional but included in the payload if present.

Cross-field guidance (enforced in UI or schema evolution):
- Avoid mixing inbound and live transfer call types.
- If `payout_model === 'Per Qualified Call'`, ensure `price_per_call` and `qual_seconds` are set (currently required already).
- If `req_tcpa` or `req_recording`, provide `proof_link` when possible (optional, recommended).

### Step gating
`IoForm.tsx` calls `trigger([...fieldNamesForStep])` before advancing. Gated fields are listed in `stepFieldNames` in `IoForm.tsx`.

### Autosave
`useAutosave`:
- Hydrates from `localStorage` key `ioFormData` on mount (`IoSchema.partial()` safeParse).
- Watches RHF state, strips `File`/`FileList`, debounce-saves (500ms) back to storage.
- This improves resilience across reloads without server state.

### Files and signatures
- `FileInput` binds a `FileList` to RHF for:
  - `buyer_w9` (single PDF)
  - `attachments` (multiple)
- `SignaturePad` captures a PNG dataURL:
  - `sig_buyer_data`, `sig_seller_data`
  - Associated name/title/date fields are separate inputs.

### Submit
`IoForm.tsx → onSubmit`:
1. Checks for `File`/`FileList` to choose `multipart` vs `x-www-form-urlencoded`.
2. Merges Seller defaults from `org.ts`.
3. Posts to `/` using `postToNetlify`.
4. Shows basic success state on `res.ok`.

---

## Printing
- Use the “Print” button on the Review step or your browser’s print dialog.
- Buttons include `print:hidden` to hide controls in print.
- For custom page breaks, extend Tailwind with `break-before` utilities or add rules in `index.css` under `@media print`.

---

## Accessibility
- Each step section has clear labels and focus outlines.
- An aria-live region announces validation errors on the current step.
- Inputs use `aria-describedby` for helper text on file pickers.

---

## Development workflow

### Common tasks
- Add/modify fields in `schema.ts`, then wire inputs in the relevant step file under `steps/`.
- Update `stepFieldNames` in `IoForm.tsx` if you add or remove required fields.
- For new files:
  - Prefer `FileInput` to get RHF + a11y bindings out of the box.
  - Validate size/type on the server or add client hints (the component currently exposes helper text; file size validation can be added if needed).
- For signatures:
  - `SignaturePad` writes a dataURL to a hidden input that RHF tracks.
  - If you need Blobs instead of dataURLs (e.g., to send as files), you can add a conversion step and switch the submit to `multipart`.

### Styling
- Keep using Tailwind utility classes for consistent theming.
- Prefer `text-slate-*` and `bg-slate-*` scales for neutral UI.
- Use `print:` variants for print-only behavior.

---

## Deployment (Netlify)

### Netlify configuration
- SPA fallback and functions redirect are defined in `netlify.toml` (already present).
- Netlify Forms works as long as the form name matches (`io-form`) and the hidden inputs are present.

### CI/release
- Build command: `pnpm build`
- Publish directory: `dist/`

If you need server-side processing, add Netlify Functions under `netlify/functions/` and route submissions from the Netlify form webhook to your CRM.

---

## Troubleshooting
- Form submission doesn’t appear in Netlify:
  - Ensure the deployed HTML contains the `data-netlify` attributes and hidden inputs.
  - Verify that you are posting to `/` and not an SPA route.
  - For files, confirm the request is `multipart/form-data`.
- Red background persists:
  - Dev cache: restart `pnpm dev`. Ensure `App.tsx` gradient classes are present.
- “Listener indicated an async response…” console message:
  - Usually a browser extension artifact; test in a clean/incognito window.

---

## Roadmap / optional
- Add analytics hooks in `src/lib/analytics.ts` (step_view, validation_error, submit_success).
- Role chooser to support Buyer‑initiated IOs.
- reCAPTCHA integration and spam signaling.
- Dedicated print layout with page breaks per section.

---

## License
Internal use. Update this section with your organization’s license policy if publishing externally.


